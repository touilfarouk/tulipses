<!DOCTYPE html>
<html lang="en">
<head>
    <title>Moneyballs - Money Tracker</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="A simple money tracking application">
    <meta name="theme-color" content="#00695c">
    <link rel="icon" href="icons/favicon.ico">
    <link rel="manifest" href="manifest.json">
    <base href="/vite/">
    <link href="css/quasar.prod.css" rel="stylesheet">
    <link href="css/fonts.css" rel="stylesheet">
    <link href="css/shadows.css" rel="stylesheet">
    <link href="css/transitions.css" rel="stylesheet">
    <style>
        .error-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 2rem;
            z-index: 9999;
            font-family: Arial, sans-serif;
            overflow: auto;
        }
        .error-message {
            background: #b71c1c;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            white-space: pre-wrap;
        }
        .debug-info {
            background: #333;
            padding: 1rem;
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
            margin-top: 1rem;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div id="q-app">
        <div class="q-loading" style="font-size: 30px">
            <div class="q-loading-spinner"></div>
        </div>
    </div>

    <!-- Load Vue and dependencies from local files -->
    <script src="js/vue.global.prod.js"></script>
    <script src="js/vue-router.global.prod.js"></script>
    <script src="js/quasar.umd.prod.js"></script>
    <script src="js/axios.min.js"></script>
    <script src="js/QCalendarMonth.umd.min.js"></script>
    <script src="js/Timestamp.umd.min.js"></script>
    <script src="js/en-US.umd.prod.js"></script>
    <script src="js/fr.umd.prod.js"></script>
    <script src="js/ar.umd.prod.js"></script>
    <script src="js/store.js"></script>

    <script>
    // Debug information
    console.log('Starting application initialization...');
    console.log('Base URL:', window.location.href);
    console.log('Scripts loading from:', window.location.origin + '/vite/');

    // Set base URL based on environment
    const isGitHubPages = window.location.hostname === 'touilfarouk.github.io';
    const basePath = isGitHubPages ? '/vite/' : '/';

    // Create global Vue app
    const { createApp } = Vue;
    const { createRouter, createWebHashHistory } = VueRouter;

    // Initialize Quasar
    const quasarUserOptions = {
        config: {
            brand: {
                primary: '#1976D2',
                secondary: '#26A69A',
                accent: '#9C27B0',
                dark: '#1D1D1D',
                positive: '#21BA45',
                negative: '#C10015',
                info: '#31CCEC',
                warning: '#F2C037'
            }
        }
    };

    // Track component loading
    const loadedComponents = {};

    // Load component scripts
    async function loadComponent(name, path) {
        return new Promise((resolve, reject) => {
            if (loadedComponents[name]) {
                console.log('Component already loaded:', name);
                return resolve();
            }

            const script = document.createElement('script');
            script.src = path;
            script.onload = () => {
                console.log('Component loaded successfully:', name);
                loadedComponents[name] = true;
                resolve();
            };
            script.onerror = (error) => {
                console.error('Failed to load component:', name, error);
                reject(new Error(`Failed to load component: ${name}`));
            };
            document.body.appendChild(script);
        });
    }

    // Load components in order
    const components = [
        { name: 'MainLayout', path: './src/layouts/MainLayout.js' },
        { name: 'PageEntries', path: './src/pages/PageEntries.js' },
        { name: 'PageSettings', path: './src/pages/PageSettings.js' }
    ];

    function showError(message, details = '') {
        console.error(message, details);
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-overlay';
        errorDiv.innerHTML = `
            <h2>Application Error</h2>
            <div class="error-message">${message}</div>
            <div class="debug-info">
                <h3>Debug Information:</h3>
                <div>${details}</div>
                <h3>Loaded Components:</h3>
                <pre>${JSON.stringify(loadedComponents, null, 2)}</pre>
                <h3>Window Variables:</h3>
                <pre>Vue: ${!!window.Vue}
VueRouter: ${!!window.VueRouter}
Quasar: ${!!window.Quasar}
axios: ${!!window.axios}
MainLayout: ${!!window.MainLayout}
PageEntries: ${!!window.PageEntries}
PageSettings: ${!!window.PageSettings}</pre>
            </div>
        `;
        document.body.appendChild(errorDiv);
    }

    // Wait for components to be registered
    async function waitForComponents() {
        const maxAttempts = 10;
        let attempts = 0;

        return new Promise((resolve, reject) => {
            const checkComponents = () => {
                attempts++;
                console.log(`Checking for components (attempt ${attempts})...`, {
                    MainLayout: !!window.MainLayout,
                    PageEntries: !!window.PageEntries,
                    PageSettings: !!window.PageSettings
                });

                if (window.MainLayout && window.PageEntries && window.PageSettings) {
                    console.log('All components found!');
                    resolve();
                } else if (attempts < maxAttempts) {
                    setTimeout(checkComponents, 100);
                } else {
                    const missing = [];
                    if (!window.MainLayout) missing.push('MainLayout');
                    if (!window.PageEntries) missing.push('PageEntries');
                    if (!window.PageSettings) missing.push('PageSettings');
                    reject(new Error(`Timed out waiting for components to load. Missing: ${missing.join(', ')}`));
                }
            };

            checkComponents();
        });
    }

    // Initialize the app
    async function initializeApp() {
        try {
            // Load all components
            for (const component of components) {
                await loadComponent(component.name, component.path).catch(error => {
                    throw new Error(`Failed to load component: ${component.name}\n${error.message}`);
                });
            }

            // Wait for components to be registered
            console.log('All scripts loaded, waiting for components to register...');
            await waitForComponents();

            // Verify all required globals are available
            const required = {
                'Vue': window.Vue,
                'VueRouter': window.VueRouter,
                'Quasar': window.Quasar,
                'axios': window.axios
            };

            const missing = Object.entries(required)
                .filter(([_, value]) => !value)
                .map(([name]) => name);

            if (missing.length > 0) {
                throw new Error(`Missing required dependencies: ${missing.join(', ')}`);
            }

            // Create app instance
            const app = createApp({
                template: '<router-view></router-view>'
            });

            // Configure Quasar
            app.use(Quasar, quasarUserOptions);

            // Create router
            const router = createRouter({
                history: createWebHashHistory(basePath),
                routes: [
                    {
                        path: '/',
                        component: window.MainLayout,
                        children: [
                            {
                                path: '',
                                component: window.PageEntries,
                                name: 'home'
                            },
                            {
                                path: 'settings',
                                component: window.PageSettings,
                                name: 'settings'
                            }
                        ]
                    }
                ]
            });

            // Mount the app
            app.use(router).mount('#q-app');

            // Hide loading spinner
            const loading = document.querySelector('.q-loading');
            if (loading) {
                loading.style.display = 'none';
            }

            console.log('App initialized successfully');

        } catch (error) {
            showError(
                'Failed to initialize application',
                `Error: ${error.message}\n\nStack: ${error.stack || 'No stack trace available'}`
            );
        }
    }

    // Start the app
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeApp);
    } else {
        initializeApp();
    }
    </script>
</body>
</html>
